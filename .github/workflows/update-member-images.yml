name: Update Member Images

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹ï¼ˆUTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 2 * * 1'
  
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-images:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout frontend repo
        uses: actions/checkout@v3
        with:
          path: frontend
      
      - name: Checkout backend repo
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/sakamichi-blog-backend
          token: ${{ secrets.GITHUB_TOKEN }}
          path: backend
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        working-directory: backend
        run: npm install
      
      - name: Fetch member images
        working-directory: backend
        run: |
          # æŠ“å–æ‰€æœ‰å›¢ä½“çš„æˆå‘˜å›¾ç‰‡
          node scripts/fetch-real-member-images.js
          node scripts/fetch-nogizaka-api.js
          echo "Image fetch completed"
      
      - name: Smart backup check
        working-directory: backend
        run: |
          # æ™ºèƒ½å¤‡ä»½ï¼šåªåœ¨ç…§ç‰‡å˜åŒ–æ—¶åˆ›å»ºæ–°å¤‡ä»½
          node scripts/smart-backup-images.js
      
      - name: Check for changes
        id: check_changes
        working-directory: frontend
        run: |
          if [ -f "data/member-images.json" ]; then
            git add data/member-images.json
            git add data/backups/*.json 2>/dev/null || true
            if git diff --staged --quiet; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No changes detected"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Changes detected"
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "File not found"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        working-directory: frontend
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æˆå‘˜å›¾ç‰‡æ•°æ® [skip ci]"
          git push
      
      - name: No changes to commit
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "âœ… æˆå‘˜å›¾ç‰‡æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°"
