<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‚é“åšå®¢ç¿»è¯‘</title>
  
  <!-- DaisyUI + Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- å…¨å±€é…ç½®ï¼ˆå¿…é¡»æœ€å…ˆåŠ è½½ï¼‰ -->
  <script src="js/config.js"></script>
  
  <!-- æ ¸å¿ƒé…ç½®æ¨¡å— -->
  <script src="js/group-config.js"></script>
  
  <!-- ğŸ†• æˆå‘˜æ•°æ®API -->
  <script type="module" src="js/members-api.js"></script>
  <!-- âš ï¸ ä¿ç•™ä½œä¸ºå›é€€ -->
  <script src="js/members-data.js"></script>

  <!-- ç»“æ„åŒ–å†…å®¹æ¸²æŸ“å™¨ -->
  <script src="js/structured-renderer.js"></script>

  <!-- å›¾ç‰‡ä¸‹è½½åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  
  <!-- OpenCC ç®€ç¹è½¬æ¢åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
  
  <!-- ä¸»é¢˜åˆ‡æ¢æ¨¡å— -->
  <script src="js/theme-toggle.js"></script>
  
  <!-- ç®€ç¹åˆ‡æ¢æ¨¡å— -->
  <script src="js/language-toggle.js"></script>
  
  <!-- æ ¸å¿ƒåŠŸèƒ½æ¨¡å— -->
  <script src="js/pagination.js"></script>
  <script src="js/router.js"></script>
  <script src="js/scroll-animations.js"></script>
  
  <!-- æˆå‘˜é¡µé¢æ¨¡å— -->
  <script src="js/member-default-images.js"></script>
  <script src="js/member-page.js"></script>
  <script src="js/member-detail.js"></script>
  <script src="js/blog-detail-sidebar.js"></script>
  
  <!-- CSSæ¨¡å— -->
  <link rel="stylesheet" href="css/main-styles.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/transitions.css">
  <link rel="stylesheet" href="css/calendar-component.css">
  <link rel="stylesheet" href="css/dark-theme.css">
  <!-- åŒè¯­åšå®¢æ ·å¼ -->
  <link rel="stylesheet" href="css/bilingual.css">
  
  <style>
    /* æœ€å°å¿…è¦æ ·å¼ */
    
    /* é˜²æ­¢PCç«¯æ˜¾ç¤ºç§»åŠ¨ç«¯æœç´¢æ  */
    .mobile-search-bar {
      display: none;
    }
    
    /* åˆ†äº«èœå•æ˜¾ç¤ºæ§åˆ¶ */
    .share-menu.show {
      display: grid !important;
    }
    
    /* æ“ä½œæŒ‰é’®åŒºåŸŸ - å¢åŠ ä¸ä¸Šæ–¹å†…å®¹çš„é—´è· */
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 24px;
      padding-top: 0;
    }
    
    /* ğŸ–¼ï¸ å›¾ç‰‡å ä½ç¬¦ä¼˜åŒ– - 30è¡Œç®€å•æ–¹æ¡ˆ */
    .blog-image-wrapper {
      background: #f5f5f5;
      border-radius: 8px;
      min-height: 200px;
      overflow: hidden;
      position: relative;
    }
    
    .blog-image-wrapper img {
      width: 100%;
      height: auto;
      display: block;
      opacity: 0;
      transition: opacity 0.3s ease-in;
    }
    
    .blog-image-wrapper img.loaded {
      opacity: 1;
    }
  </style>
</head>
<body>
  
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50 border-b">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between" style="height: 56px;">
        <!-- å·¦ä¾§ï¼šæ ‡é¢˜ + æ ‡ç­¾é¡µ -->
        <div class="flex items-center gap-8">
          <h1 class="text-xl font-bold whitespace-nowrap">å‚é“åšå®¢ç¿»è¯‘</h1>
          
          <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
          <div class="flex items-center desktop-tabs">
            <div class="tab-item active" data-group="all" onclick="Router.navigate('#all')">å…¨éƒ¨</div>
            <div class="tab-item" data-group="nogizaka" onclick="Router.navigate('#nogizaka')">ä¹ƒæœ¨å‚46</div>
            <div class="tab-item" data-group="sakurazaka" onclick="Router.navigate('#sakurazaka')">æ¨±å‚46</div>
            <div class="tab-item" data-group="hinatazaka" onclick="Router.navigate('#hinatazaka')">æ—¥å‘å‚46</div>
          </div>
        </div>
        
        <!-- å³ä¾§ï¼šæœç´¢ + ä¸»é¢˜åˆ‡æ¢ + æ±‰å ¡èœå• -->
        <div class="flex items-center gap-3">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="æœç´¢æˆå‘˜æˆ–æ ‡é¢˜..." 
            class="input input-bordered input-sm w-64"
            style="height: 36px;"
            onkeyup="handleSearchInput(event)"
          />
          
          <!-- PCç«¯ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
          <button id="themeToggleDesktop" class="theme-toggle-btn desktop-only" title="åˆ‡æ¢ä¸»é¢˜">
            <svg class="theme-icon-light" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="theme-icon-dark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
          </button>
          
          <!-- PCç«¯ç®€ç¹åˆ‡æ¢æŒ‰é’® -->
          <button id="langToggleDesktop" class="lang-toggle-btn desktop-only" title="åˆ‡æ¢åˆ°ç¹ä½“ä¸­æ–‡">
            <span class="lang-text">ç®€</span>
          </button>
          
          <!-- ç§»åŠ¨ç«¯æ±‰å ¡èœå•æŒ‰é’® -->
          <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ èœå• -->
  <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
  <div class="mobile-sidebar">
    <div class="mobile-sidebar-header">
      <h2>èœå•</h2>
      <button class="mobile-sidebar-close" onclick="toggleMobileMenu()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <!-- ç§»åŠ¨ç«¯æœç´¢æ¡† -->
    <div class="mobile-search-bar">
      <input 
        type="text" 
        id="mobileSearchInput" 
        placeholder="æœç´¢æˆå‘˜æˆ–æ ‡é¢˜..." 
        class="mobile-search-input"
        onkeyup="handleSearchInput(event)"
      />
    </div>
    
    <nav class="mobile-sidebar-nav">
      <div class="mobile-nav-item active" data-group="all" onclick="Router.navigate('#all')">å…¨éƒ¨</div>
      <div class="mobile-nav-item" data-group="nogizaka" onclick="Router.navigate('#nogizaka')">ä¹ƒæœ¨å‚46</div>
      <div class="mobile-nav-item" data-group="sakurazaka" onclick="Router.navigate('#sakurazaka')">æ¨±å‚46</div>
      <div class="mobile-nav-item" data-group="hinatazaka" onclick="Router.navigate('#hinatazaka')">æ—¥å‘å‚46</div>
    </nav>
    
    <!-- ç§»åŠ¨ç«¯ä¸»é¢˜åˆ‡æ¢ -->
    <div class="mobile-theme-toggle">
      <button id="themeToggleMobile" class="theme-toggle-btn-mobile">
        <svg class="theme-icon-light" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="theme-icon-dark" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
        <span class="theme-text">äº®è‰²æ¨¡å¼</span>
      </button>
    </div>
    
    <!-- ç§»åŠ¨ç«¯ç®€ç¹åˆ‡æ¢ -->
    <div class="mobile-lang-toggle">
      <button id="langToggleMobile" class="lang-toggle-btn-mobile">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h2m-1 0v6"/>
        </svg>
        <span class="lang-text">ç®€ä½“ä¸­æ–‡</span>
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- å›¢ä½“ä¿¡æ¯åŒºåŸŸ (ä»…åœ¨é€‰æ‹©ç‰¹å®šå›¢ä½“æ—¶æ˜¾ç¤º) -->
    <div id="groupInfo" class="hidden mb-8">
      <!-- ç»Ÿè®¡ä¿¡æ¯å’Œç­›é€‰å™¨ -->
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="grid grid-cols-2 gap-4 flex-1">
          <div class="stat-card">
            <div class="stat-number" id="memberCount">-</div>
            <div class="stat-label">æˆå‘˜æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="todayCount">-</div>
            <div class="stat-label">ä»Šæ—¥æ›´æ–°</div>
          </div>
        </div>
        
        <!-- æˆå‘˜ç­›é€‰å™¨ -->
        <div class="filter-card" style="min-width: 300px;">
          <div class="filter-label">FILTER</div>
          <select id="memberSelect" class="select select-bordered w-full" onchange="filterByMember()">
            <option value="">å…¨éƒ¨æˆå‘˜</option>
          </select>
        </div>
      </div>
    </div>

    <!-- åšå®¢åˆ—è¡¨ -->
    <div class="mb-8">
      <div id="blogsContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-4 gap-4" style="min-height: 400px;">
        <!-- åšå®¢å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ 4x8=32ç¯‡å¸ƒå±€ -->
      </div>
    </div>

    <!-- åŠ è½½ä¸­ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼Œé»˜è®¤æ˜¾ç¤ºï¼‰ -->
    <div id="loadingState" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-90 z-40">
      <div class="text-center">
        <span class="loading loading-spinner loading-lg"></span>
        <p class="mt-4 text-gray-600">åŠ è½½ä¸­...</p>
      </div>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div id="emptyState" class="hidden text-center py-12 bg-white">
      <p class="text-gray-500">æš‚æ— åšå®¢</p>
    </div>

    <!-- æ»šåŠ¨æç¤º -->
    <div id="scrollHint" class="hidden text-center mb-8">
      <div class="inline-flex flex-col items-center text-gray-400">
        <span class="text-sm mb-2">ç»§ç»­æ»šåŠ¨æŸ¥çœ‹æ›´å¤š</span>
        <svg class="animate-bounce w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
        </svg>
      </div>
    </div>
    
    <!-- ç¿»é¡µç»„ä»¶ -->
    <div id="paginationContainer" class="hidden mb-8 mt-8">
      <div class="flex flex-col items-center gap-4">
        <!-- é¡µç ä¿¡æ¯ -->
        <div id="pageInfo" class="text-sm text-gray-600 font-medium"></div>
        
        <!-- ç¿»é¡µæŒ‰é’® -->
        <div class="inline-flex items-center gap-2">
          <button id="prevPageBtn" class="flex items-center justify-center w-8 h-8 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          
          <div id="pageButtons" class="flex items-center gap-1">
            <!-- é¡µç æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </div>
          
          <button id="nextPageBtn" class="flex items-center justify-center w-8 h-8 text-sm border border-gray-300 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- æ— é™æ»šåŠ¨å“¨å…µï¼ˆç”¨äºè§¦å‘åŠ è½½ï¼‰ -->
    <div id="scrollSentinel" class="hidden" style="height: 1px;"></div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ï¼ˆåŠ è½½æ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="loadingIndicator" class="hidden text-center mb-8">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        <span class="ml-3 text-gray-600">åŠ è½½ä¸­...</span>
      </div>
    </div>

    <!-- ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ–ãƒ­ã‚° (ä»…åœ¨é€‰æ‹©ç‰¹å®šå›¢ä½“æ—¶æ˜¾ç¤ºï¼Œåœ¨åšå®¢åˆ—è¡¨ä¸‹æ–¹) -->
    <div id="memberListSection" class="hidden bg-white p-8">
      <h2 class="section-title">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ–ãƒ­ã‚°</h2>
      <div id="memberGrid" class="member-grid">
        <!-- æˆå‘˜æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-16">
    <div class="container mx-auto px-4 py-8 text-center text-sm text-gray-600">
      <p class="font-bold mb-2">å‚é“åšå®¢ç¿»è¯‘ç³»ç»Ÿ</p>
      <p>åŸºäº Cloudflare Workers + Gemini AI æ„å»º</p>
    </div>
  </footer>

  <script>
    // âŒ å·²åˆ é™¤ API é…ç½® - ä½¿ç”¨ app.js ä¸­çš„ window.API_BASE_URLï¼ˆå¸¦å¥åº·æ£€æŸ¥ï¼‰
    // âœ… å·²è¿ç§»å…¨å±€å˜é‡ - ç»Ÿä¸€ä½¿ç”¨ App.state.page, App.state.group, App.state.search ç­‰
    // âŒ å·²åˆ é™¤å›¢ä½“é…ç½® - ä½¿ç”¨ js/group-config.js æ¨¡å—ä¸­çš„ window.GroupConfig

    // åˆ‡æ¢å›¢ä½“
    async function switchGroup(group) {
      console.log('åˆ‡æ¢å›¢ä½“:', group);
      if (!window.Router) {
        console.error('Router æœªåˆå§‹åŒ–ï¼');
        return;
      }
      
      // è®¾ç½®ç»Ÿä¸€çŠ¶æ€
      App.state.group = group;
      App.state.page = 1;  // âœ… ä»1å¼€å§‹ï¼Œé¿å…è´Ÿåç§»
      App.state.search = '';
      App.state.hasMore = true;
      App.state.loading = false;
      
      // ä¸å†ä½¿ç”¨ history.pushStateï¼ŒRouter ä¼šå¤„ç†è·¯ç”±
      
      // åŒæ­¥PCç«¯å’Œç§»åŠ¨ç«¯èœå•çŠ¶æ€
      if (typeof syncMenuActiveState === 'function') {
        syncMenuActiveState(group);
      } else {
        // å‘åå…¼å®¹ï¼šç›´æ¥æ›´æ–°æ ‡ç­¾çŠ¶æ€
        document.querySelectorAll('.tab-item').forEach(tab => {
          tab.classList.remove('active');
          if (tab.dataset.group === group) {
            tab.classList.add('active');
          }
        });
      }
      
      // æ˜¾ç¤º/éšè—å›¢ä½“ä¿¡æ¯å’Œãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ–ãƒ­ã‚°
      const groupInfo = document.getElementById('groupInfo');
      const memberListSection = document.getElementById('memberListSection');
      
      if (group !== 'all') {
        groupInfo.classList.remove('hidden');
        memberListSection.classList.remove('hidden');
        await loadGroupInfo(group);
      } else {
        groupInfo.classList.add('hidden');
        memberListSection.classList.add('hidden');
      }
      
      await loadBlogs();
    }

    // åŠ è½½å›¢ä½“ä¿¡æ¯
    window.loadGroupInfo = async function loadGroupInfo(group) {
      try {
        const groupName = window.GroupConfig?.getDisplayName(group) || group;
        // è·å–æ›´å¤šåšå®¢ä»¥ç¡®ä¿æ‰€æœ‰æˆå‘˜çš„æœ€åæ›´æ–°æ—¥æœŸéƒ½èƒ½è·å–åˆ°
        const apiBase = window.API_BASE_URL || window.API_BASE;
        const response = await fetch(`${apiBase}/api/blogs?group=${encodeURIComponent(groupName)}&limit=500`);
        const data = await response.json();
        
        if (data.success && data.blogs) {
          // ğŸ†• ä»åç«¯APIè·å–å›¢ä½“çš„å®Œæ•´æˆå‘˜åˆ—è¡¨
          let groupData;
          try {
            const membersResponse = await fetch(`${apiBase}/api/members/${group}`);
            console.log('[loadGroupInfo] members API å“åº”çŠ¶æ€:', membersResponse.status);
            if (membersResponse.ok) {
              groupData = await membersResponse.json();
              console.log('[loadGroupInfo] members API è¿”å›æ•°æ®:', groupData);
            } else {
              console.error('[loadGroupInfo] members API è¯·æ±‚å¤±è´¥:', membersResponse.status);
            }
          } catch (e) {
            // å›é€€åˆ°æœ¬åœ°æ•°æ®
            console.warn('[loadGroupInfo] APIè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', e);
            groupData = window.MEMBERS_DATA ? { generations: window.MEMBERS_DATA[group]?.generations } : null;
          }
          
          let totalMembers = 0;
          let allMembers = [];
          let memberLastUpdate = {};
          
          if (groupData && groupData.generations) {
            console.log('[loadGroupInfo] æ‰¾åˆ°æœŸåˆ«æ•°æ®ï¼ŒæœŸæ•°:', groupData.generations.length);
            // è®¡ç®—æ‰€æœ‰æœŸåˆ«çš„æ€»æˆå‘˜æ•°
            groupData.generations.forEach(generation => {
              totalMembers += generation.members.length;
              allMembers.push(...generation.members);
            });
            console.log('[loadGroupInfo] æ€»æˆå‘˜æ•°:', totalMembers, 'æˆå‘˜åˆ—è¡¨:', allMembers.slice(0, 5), '...');
          } else {
            console.error('[loadGroupInfo] âŒ æ²¡æœ‰æœŸåˆ«æ•°æ®ï¼groupData:', groupData);
          }
          
          // è®¡ç®—æ¯ä¸ªæˆå‘˜çš„æœ€åæ›´æ–°æ—¥æœŸ
          data.blogs.forEach(blog => {
            if (blog.member && blog.publish_date) {
              const member = blog.member;
              const dateStr = blog.publish_date;
              
              // è½¬æ¢æ—¥æœŸå­—ç¬¦ä¸²ä¸ºå¯æ¯”è¾ƒçš„æ ¼å¼
              // æ”¯æŒ "2025/10/08 21:12" å’Œ "2025.10.8 21:12" æ ¼å¼
              const normalizedDate = dateStr.replace(/\./g, '/');
              
              if (!memberLastUpdate[member]) {
                memberLastUpdate[member] = normalizedDate;
              } else {
                // æ¯”è¾ƒæ—¥æœŸæ—¶é—´
                const currentDate = new Date(memberLastUpdate[member].replace(/\//g, '-'));
                const newDate = new Date(normalizedDate.replace(/\//g, '-'));
                if (newDate > currentDate) {
                  memberLastUpdate[member] = normalizedDate;
                }
              }
            }
          });
          
          // æ›´æ–°æˆå‘˜æ•°ï¼ˆæ˜¾ç¤ºå›¢ä½“çš„å®é™…æˆå‘˜æ€»æ•°ï¼‰
          document.getElementById('memberCount').textContent = totalMembers;
          
          // å‡†å¤‡å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ï¼ˆåŒ…æ‹¬æ²¡æœ‰åšå®¢çš„æˆå‘˜ï¼‰
          // âš ï¸ æ ‡å‡†åŒ–åå­—ï¼šç§»é™¤ç©ºæ ¼ä»¥åŒ¹é… members API çš„æ ¼å¼
          const membersWithBlogs = [...new Set(data.blogs
            .map(blog => blog.member)
            .filter(member => member && member !== 'æœªçŸ¥æˆå‘˜' && !member.includes('æœªçŸ¥'))
            .map(member => member.replace(/\s+/g, ''))  // ç§»é™¤æ‰€æœ‰ç©ºæ ¼
          )].sort();
          console.log('[loadGroupInfo] æœ‰åšå®¢çš„æˆå‘˜ï¼ˆæ ‡å‡†åŒ–åï¼‰:', membersWithBlogs.slice(0, 5), '...');
          
          // æ›´æ–°ä»Šæ—¥æ›´æ–°æ•°ï¼ˆä½¿ç”¨æ—¥æœ¬æ—¶åŒºï¼‰
          const now = new Date();
          const japanTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
          const today = japanTime.toISOString().split('T')[0]; // æ—¥æœ¬å½“åœ°æ—¥æœŸ
          
          console.log('[ä»Šæ—¥æ›´æ–°] å½“å‰æ—¥æœ¬æ—¶é—´:', japanTime.toLocaleString('zh-CN', { timeZone: 'Asia/Tokyo' }));
          console.log('[ä»Šæ—¥æ›´æ–°] ä»Šå¤©çš„æ—¥æœŸ:', today);
          console.log('[ä»Šæ—¥æ›´æ–°] å…±è·å–åšå®¢æ•°:', data.blogs.length);
          
          const todayBlogs = data.blogs.filter(blog => {
            if (!blog.publish_date) return false;
            
            // ä½¿ç”¨é€šç”¨æ—¥æœŸè§£æå‡½æ•°
            const blogDate = window.parseBlogDate ? window.parseBlogDate(blog.publish_date) : new Date(blog.publish_date);
            if (!blogDate) return false;
            
            const blogDateStr = blogDate.toISOString().split('T')[0];
            const isToday = blogDateStr === today;
            
            if (isToday) {
              console.log('[ä»Šæ—¥æ›´æ–°] æ‰¾åˆ°ä»Šå¤©çš„åšå®¢:', blog.member, blog.title, blog.publish_date);
            }
            return isToday;
          });
          
          console.log('[ä»Šæ—¥æ›´æ–°] ä»Šæ—¥æ›´æ–°æ•°:', todayBlogs.length);
          document.getElementById('todayCount').textContent = todayBlogs.length;
          
          // å¡«å……ç­›é€‰å™¨ä¸‹æ‹‰æ¡†ï¼ˆæ˜¾ç¤ºå…¨éƒ¨æˆå‘˜å’Œæœ€åæ›´æ–°æ—¶é—´ï¼ŒæŒ‰æœŸåˆ«æ’åºï¼‰
          populateMemberSelect(groupData, memberLastUpdate);
          
          // å¡«å……ãƒ¡ãƒ³ãƒãƒ¼åˆ«ãƒ–ãƒ­ã‚°ç½‘æ ¼ï¼ˆæ˜¾ç¤ºå®Œæ•´æˆå‘˜åˆ—è¡¨ï¼ŒæŒ‰æœŸåˆ«ï¼‰
          await renderMemberGrid(allMembers, membersWithBlogs);
        }
      } catch (error) {
        console.error('åŠ è½½å›¢ä½“ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // å¡«å……æˆå‘˜ç­›é€‰ä¸‹æ‹‰æ¡†
    function populateMemberSelect(groupData, memberLastUpdate = {}) {
      const select = document.getElementById('memberSelect');
      select.innerHTML = '<option value="">å…¨éƒ¨æˆå‘˜</option>';
      
      if (!groupData || !groupData.generations) {
        return;
      }
      
      // æŒ‰æœŸåˆ«é¡ºåºæ˜¾ç¤ºæˆå‘˜
      groupData.generations.forEach(generation => {
        generation.members.forEach(member => {
          const option = document.createElement('option');
          option.value = member;
          
          // æ ¼å¼åŒ–æ˜¾ç¤ºæ–‡æœ¬ï¼šæˆå‘˜å + æœ€åæ›´æ–°æ—¶é—´
          let displayText = member;
          if (memberLastUpdate[member]) {
            // å°†æ—¥æœŸæ ¼å¼ä» "2025/10/08 21:12" è½¬æ¢ä¸º "10.08 21:12 æ›´æ–°"
            const date = memberLastUpdate[member];
            const parts = date.split(' ');
            if (parts.length >= 2) {
              const datePart = parts[0]; // "2025/10/08"
              const timePart = parts[1]; // "21:12"
              const dateComponents = datePart.split('/'); // ["2025", "10", "08"]
              if (dateComponents.length === 3) {
                const month = dateComponents[1].padStart(2, '0');
                const day = dateComponents[2].padStart(2, '0');
                displayText = `${member}ï¼ˆ${month}.${day} ${timePart} æ›´æ–°ï¼‰`;
              } else {
                // å¦‚æœæ ¼å¼ä¸å¯¹ï¼Œè‡³å°‘æ˜¾ç¤ºåŸå§‹æ—¥æœŸ
                displayText = `${member}ï¼ˆ${date}ï¼‰`;
              }
            } else if (parts.length === 1) {
              // åªæœ‰æ—¥æœŸæ²¡æœ‰æ—¶é—´
              const datePart = parts[0];
              const dateComponents = datePart.split('/');
              if (dateComponents.length === 3) {
                const month = dateComponents[1].padStart(2, '0');
                const day = dateComponents[2].padStart(2, '0');
                displayText = `${member}ï¼ˆ${month}.${day} æ›´æ–°ï¼‰`;
              }
            }
          } else {
            displayText = `${member}ï¼ˆæœªæ›´æ–°ï¼‰`;
          }
          
          option.textContent = displayText;
          select.appendChild(option);
        });
      });
    }

    // æ¸²æŸ“ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ãƒ–ãƒ­ã‚°ç½‘æ ¼ï¼ˆæŒ‰æœŸåˆ«ï¼‰
    async function renderMemberGrid(members, membersWithBlogs = []) {
      console.log('[renderMemberGrid] è°ƒç”¨ï¼Œå½“å‰å›¢ä½“:', App.state.group, 'membersæ•°:', members.length, 'æœ‰åšå®¢çš„æˆå‘˜æ•°:', membersWithBlogs.length);
      const grid = document.getElementById('memberGrid');
      if (!grid) {
        console.error('[renderMemberGrid] âŒ æ‰¾ä¸åˆ° memberGrid å…ƒç´ ï¼');
        return;
      }
      
      // âš ï¸ ç¡®ä¿ App.state.group å·²è®¾ç½®
      if (!App.state.group || App.state.group === 'all') {
        console.warn('[renderMemberGrid] âš ï¸ App.state.group æœªæ­£ç¡®è®¾ç½®æˆ–ä¸º allï¼Œè·³è¿‡æ¸²æŸ“');
        return;
      }
      
      grid.innerHTML = '';
      
      // ğŸ†• ä»åç«¯APIè·å–å½“å‰å›¢ä½“çš„æœŸåˆ«æ•°æ®
      let groupData;
      try {
        const apiBase = window.API_BASE_URL || window.API_BASE;
        const response = await fetch(`${apiBase}/api/members/${App.state.group}`);
        console.log('[renderMemberGrid] members API çŠ¶æ€:', response.status);
        if (response.ok) {
          groupData = await response.json();
          console.log('[renderMemberGrid] è·å–åˆ°æœŸåˆ«æ•°æ®ï¼ŒæœŸæ•°:', groupData.generations?.length);
        }
      } catch (e) {
        // å›é€€åˆ°æœ¬åœ°æ•°æ®
        console.warn('[renderMemberGrid] APIè·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', e);
        groupData = window.MEMBERS_DATA ? { generations: window.MEMBERS_DATA[App.state.group]?.generations } : null;
      }
      if (!groupData) {
        // å¦‚æœæ²¡æœ‰æœŸåˆ«æ•°æ®ï¼Œä½¿ç”¨åŸæ¥çš„æ–¹å¼
        members.forEach(member => {
          const item = document.createElement('div');
          item.className = 'member-item';
          item.textContent = member;
          
          // å¦‚æœæ²¡æœ‰åšå®¢ï¼Œæ·»åŠ ç°è‰²æ ·å¼
          if (!membersWithBlogs.includes(member)) {
            item.classList.add('opacity-50');
          }
          
          item.onclick = () => {
            // ä½¿ç”¨ Router å¯¼èˆªåˆ°æˆå‘˜é¡µé¢
            Router.navigate(`#${App.state.group}/member/${encodeURIComponent(member)}`);
          };
          grid.appendChild(item);
        });
        return;
      }
      
      // æŒ‰æœŸåˆ«æ˜¾ç¤º
      console.log('[renderMemberGrid] å¼€å§‹æŒ‰æœŸåˆ«æ¸²æŸ“ï¼ŒæœŸæ•°:', groupData.generations.length);
      groupData.generations.forEach((generation, genIndex) => {
        // æœŸåˆ«æ ‡é¢˜
        const genTitle = document.createElement('div');
        genTitle.className = 'col-span-full text-sm font-bold text-gray-700 mt-4 mb-2 px-2';
        genTitle.textContent = generation.name;
        grid.appendChild(genTitle);
        console.log(`[renderMemberGrid] æ¸²æŸ“æœŸåˆ« ${genIndex + 1}: ${generation.name}, æˆå‘˜æ•°: ${generation.members.length}`);
        
        // è¯¥æœŸæˆå‘˜
        generation.members.forEach((member, memberIndex) => {
          const item = document.createElement('div');
          item.className = 'member-item';
          item.textContent = member;
          
          // å¦‚æœæ²¡æœ‰åšå®¢ï¼Œæ·»åŠ ç°è‰²æ ·å¼
          if (!membersWithBlogs.includes(member)) {
            item.classList.add('opacity-50');
          }
          
          item.onclick = () => {
            console.log('[renderMemberGrid] ç‚¹å‡»æˆå‘˜:', member);
            // ä½¿ç”¨ Router å¯¼èˆªåˆ°æˆå‘˜é¡µé¢
            Router.navigate(`#${App.state.group}/member/${encodeURIComponent(member)}`);
          };
          grid.appendChild(item);
          
          if (memberIndex === 0) {
            console.log(`[renderMemberGrid] ç¬¬ä¸€ä¸ªæˆå‘˜ç¤ºä¾‹: ${member}, æœ‰åšå®¢: ${membersWithBlogs.includes(member)}`);
          }
        });
      });
      console.log('[renderMemberGrid] âœ… æ¸²æŸ“å®Œæˆï¼Œgridå­å…ƒç´ æ•°:', grid.children.length);
    }

    // æŒ‰æˆå‘˜ç­›é€‰ï¼ˆä»ä¸‹æ‹‰æ¡†ï¼‰
    function filterByMember() {
      const select = document.getElementById('memberSelect');
      const memberName = select.value;
      
      console.log('[filterByMember] ç­›é€‰æˆå‘˜:', memberName || 'å…¨éƒ¨æˆå‘˜');
      
      // âœ… ä½¿ç”¨ç»Ÿä¸€çŠ¶æ€ç®¡ç†
      App.state.search = memberName;
      App.state.page = 1;
      App.state.hasMore = true;
      App.state.loading = false;
      
      // âœ… æ¸…ç©ºå®¹å™¨ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const container = document.getElementById('blogsContainer');
      if (container) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ­£åœ¨åŠ è½½...</div>';
      }
      
      // æ›´æ–° URL çŠ¶æ€
      history.replaceState({ 
        view: 'list', 
        group: App.state.group, 
        member: memberName || '' 
      }, '', `#${App.state.group}${memberName ? '/' + encodeURIComponent(memberName) : ''}`);
      
      // é‡æ–°åŠ è½½æ•°æ®
      loadBlogs();
    }
    
    // é‡ç½®ç­›é€‰å™¨ï¼ˆå›¢ä½“åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    window.resetMemberFilter = function() {
      const select = document.getElementById('memberSelect');
      if (select) {
        select.value = '';
        console.log('[resetMemberFilter] ç­›é€‰å™¨å·²é‡ç½®');
      }
    }

    // å¤„ç†æœç´¢è¾“å…¥ï¼ˆé¡¶éƒ¨æœç´¢æ¡†ï¼‰
    function handleSearchInput(event) {
      if (event.key === 'Enter') {
        const query = event.target.value.trim();
        console.log('[handleSearchInput] æœç´¢:', query);
        
        if (query) {
          // è°ƒç”¨æœç´¢API
          performRealSearch(query);
        } else {
          // æ¸…ç©ºæœç´¢ï¼Œé‡æ–°åŠ è½½åšå®¢åˆ—è¡¨
          App.state.search = '';
          App.state.page = 1;
          loadBlogs();
        }
      }
    }

    // è°ƒç”¨çœŸæ­£çš„æœç´¢API
    async function performRealSearch(query) {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const container = document.getElementById('blogsContainer');
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æ­£åœ¨æœç´¢...</div>';
        
        // æ„å»ºAPI URL
        const apiBase = window.API_BASE_URL || 'https://api.sakamichi-tools.cn';
        const params = new URLSearchParams({
          q: query,
          limit: 50
        });
        
        // æ·»åŠ å›¢ä½“ç­›é€‰
        if (App.state.group !== 'all') {
          const groupNames = {
            'nogizaka': 'ä¹ƒæœ¨å‚46',
            'sakurazaka': 'æ¨±å‚46',
            'hinatazaka': 'æ—¥å‘å‚46'
          };
          params.append('group', groupNames[App.state.group] || '');
        }
        
        const url = `${apiBase}/api/search?${params}`;
        console.log('[performRealSearch] è¯·æ±‚URL:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('[performRealSearch] æœç´¢ç»“æœ:', data);
        
        if (data.success && data.data) {
          // æ˜¾ç¤ºæœç´¢ç»“æœ
          displaySearchResults(data.data, query, data.count);
        } else {
          throw new Error(data.error || 'æœç´¢å¤±è´¥');
        }
      } catch (error) {
        console.error('[performRealSearch] æœç´¢å¤±è´¥:', error);
        const container = document.getElementById('blogsContainer');
        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p style="color: #f56565;">æœç´¢å¤±è´¥: ${error.message}</p>
            <p style="color: #999; margin-top: 10px;">è¯·ç¨åé‡è¯•</p>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displaySearchResults(blogs, query, count) {
      const container = document.getElementById('blogsContainer');
      container.innerHTML = '';
      
      // æ˜¾ç¤ºæœç´¢æç¤º
      const header = document.createElement('div');
      header.style.cssText = 'padding: 20px 0; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px;';
      header.innerHTML = `
        <h3 style="font-size: 18px; font-weight: 600; color: #2d3748;">
          æœç´¢ç»“æœï¼š"${query}" <span style="color: #718096;">(æ‰¾åˆ° ${count} ç¯‡åšå®¢)</span>
        </h3>
      `;
      container.appendChild(header);
      
      if (blogs.length === 0) {
        container.innerHTML += `
          <div style="text-align: center; padding: 60px 20px;">
            <svg style="width: 64px; height: 64px; margin: 0 auto 20px; color: #cbd5e0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 style="font-size: 16px; font-weight: 500; color: #2d3748; margin-bottom: 8px;">æœªæ‰¾åˆ°ç»“æœ</h3>
            <p style="color: #718096;">æ²¡æœ‰æ‰¾åˆ°ä¸"${query}"ç›¸å…³çš„åšå®¢</p>
          </div>
        `;
        return;
      }
      
      // ä½¿ç”¨å·²æœ‰çš„ renderBlogItem æ¸²æŸ“åšå®¢å¡ç‰‡
      blogs.forEach(blog => {
        const blogCard = window.renderBlogItem(blog);
        container.appendChild(blogCard);
      });
      
      // è§¦å‘æ»šåŠ¨åŠ¨ç”»
      if (window.observeElements) {
        const cards = container.querySelectorAll('.blog-card');
        setTimeout(() => window.observeElements(Array.from(cards)), 50);
      }
    }

    // æ¸²æŸ“åšå®¢å†…å®¹ - ç›´æ¥ä½¿ç”¨blog-renderer.jsä¸­çš„renderMarkdown
    function renderBlogContent(markdown, groupName) {
      // ä½¿ç”¨blog-renderer.jsä¸­çš„ç»Ÿä¸€æ¸²æŸ“é€»è¾‘
      if (window.renderMarkdown) {
        return window.renderMarkdown(markdown, groupName);
      } else {
        // åå¤‡æ–¹æ¡ˆ
        return markdown.replace(/\n/g, '<br>');
      }
    }

    // æ—¥å‘å‚46æ¸²æŸ“å‡½æ•°ï¼ˆé»˜è®¤ï¼Œæ¯è¡Œç‹¬ç«‹ï¼‰
    function renderHinatazakaContent(content) {
      const lines = content.split('\n');
      const result = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();

        // è·³è¿‡ç©ºè¡Œ
        if (trimmedLine === '') {
          continue;
        }

        // <br>æ ‡ç­¾ç›´æ¥æ·»åŠ 
        if (trimmedLine === '<br>' || trimmedLine === '<br/>') {
          result.push('<br>');
        }
        // å›¾ç‰‡è¡Œç›´æ¥æ·»åŠ 
        else if (line.includes('<img')) {
          result.push(line);
        }
        // æ‰€æœ‰æ–‡æœ¬è¡Œéƒ½ç‹¬ç«‹æ˜¾ç¤ºï¼Œä¿æŒåŸæ–‡çš„è¡Œç»“æ„
        else {
          result.push(trimmedLine);
          result.push('\n');
        }
      }

      return result.join('');
    }

    // æ¨±å‚46æ¸²æŸ“å‡½æ•°ï¼ˆæ™ºèƒ½åˆå¹¶è¢«åˆ†å‰²çš„å¥å­ï¼‰
    function renderSakurazakaContent(content) {
      const lines = content.split('\n');
      const result = [];
      let i = 0;

      while (i < lines.length) {
        const line = lines[i];
        const trimmedLine = line.trim();

        // è·³è¿‡ç©ºè¡Œ
        if (trimmedLine === '') {
          i++;
          continue;
        }

        // <br>æ ‡ç­¾ç›´æ¥æ·»åŠ 
        if (trimmedLine === '<br>' || trimmedLine === '<br/>') {
          result.push('<br>');
          i++;
        }
        // å›¾ç‰‡è¡Œç›´æ¥æ·»åŠ 
        else if (line.includes('<img')) {
          result.push(line);
          i++;
        }
        // æ–‡æœ¬è¡Œå¤„ç†
        else {
          // ç‰¹æ®Šå¤„ç†ï¼šåˆå¹¶å¼•å·å†…å®¹
          if (trimmedLine.startsWith('ã€Œ') && !trimmedLine.includes('ã€')) {
            // æ”¶é›†åˆ°ã€ä¸ºæ­¢çš„æ‰€æœ‰å†…å®¹
            let mergedContent = trimmedLine;
            i++;
            while (i < lines.length) {
              const nextLine = lines[i].trim();
              if (nextLine === '' || nextLine === '<br>' || nextLine === '<br/>') {
                i++;
                continue;
              }
              mergedContent += nextLine;
              i++;
              if (nextLine.includes('ã€')) {
                break;
              }
            }
            result.push(mergedContent);
            result.push('\n');
          }
          // æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦ä¸å‰ä¸€è¡Œåˆå¹¶çš„ç‰‡æ®µ
          else if (shouldMergeWithPrevious(trimmedLine, result)) {
            // ä¸å‰ä¸€è¡Œåˆå¹¶
            if (result.length > 0 && result[result.length - 1] === '\n') {
              result.pop(); // ç§»é™¤å‰ä¸€ä¸ªæ¢è¡Œ
            }
            result.push(trimmedLine);
            result.push('\n');
            i++;
          }
          // æ­£å¸¸è¡Œ
          else {
            result.push(trimmedLine);
            // æ£€æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦éœ€è¦åˆå¹¶
            if (i < lines.length - 1) {
              const nextLine = lines[i + 1].trim();
              if (!shouldMergeWithPrevious(nextLine, [trimmedLine])) {
                result.push('\n');
              }
            } else {
              result.push('\n');
            }
            i++;
          }
        }
      }

      return result.join('');
    }

    // ä¹ƒæœ¨å‚46æ¸²æŸ“å‡½æ•°ï¼ˆé€šè¿‡ç©ºè¡Œè¯†åˆ«æ®µè½ï¼‰
    function renderNogizakaContent(content) {
      const lines = content.split('\n');
      const result = [];
      let currentParagraph = [];
      let emptyLineCount = 0;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();

        // å›¾ç‰‡è¡Œç‰¹æ®Šå¤„ç†
        if (line.includes('<img')) {
          // å…ˆè¾“å‡ºå½“å‰æ®µè½
          if (currentParagraph.length > 0) {
            result.push(currentParagraph.join(''));
            result.push('\n');
            currentParagraph = [];
          }
          result.push(line);
          emptyLineCount = 0;
        }
        // ç©ºè¡Œå¤„ç†
        else if (trimmedLine === '') {
          emptyLineCount++;
          // è¿ç»­2ä¸ªæˆ–ä»¥ä¸Šç©ºè¡Œè¡¨ç¤ºæ®µè½ç»“æŸ
          if (emptyLineCount >= 2 && currentParagraph.length > 0) {
            result.push(currentParagraph.join(''));
            result.push('<br><br>');
            currentParagraph = [];
          }
        }
        // æ–‡æœ¬è¡Œ
        else {
          // å¦‚æœä¹‹å‰æœ‰ç©ºè¡Œä½†ä¸è¶³2ä¸ªï¼Œå½“ä½œåŒä¸€æ®µè½
          if (emptyLineCount === 1 && currentParagraph.length > 0) {
            // å•ä¸ªç©ºè¡Œåœ¨æ®µè½å†…å¯èƒ½æ˜¯è½¯æ¢è¡Œ
            currentParagraph.push('\n');
          }
          emptyLineCount = 0;
          currentParagraph.push(trimmedLine);
        }
      }

      // è¾“å‡ºæœ€åçš„æ®µè½
      if (currentParagraph.length > 0) {
        result.push(currentParagraph.join(''));
        result.push('\n');
      }

      return result.join('');
    }

    // åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸å‰ä¸€è¡Œåˆå¹¶ï¼ˆç”¨äºæ¨±å‚46ï¼‰
    function shouldMergeWithPrevious(line, prevResults) {
      if (!line || line === '<br>' || line === '<br/>') return false;

      // å•ä¸ªæ ‡ç‚¹ç¬¦å·æˆ–å¾ˆçŸ­çš„å¥å°¾
      if (line.match(/^[ã€‚ï¼ï¼Ÿã€ï¼Œ,]$/) || line.match(/^.{1,2}[ã€‚ï¼ï¼Ÿ]$/)) {
        return true;
      }

      // å•ä¸ªè¯­æ°”è¯
      if (line.match(/^(å‘¢|å§|å•Š|å˜›|å“¦|å•¦|å‘€|å—|çš„|äº†)$/)) {
        return true;
      }

      // ç»“æŸå¼•å·å•ç‹¬æˆè¡Œ
      if (line === 'ã€' || line === '"' || line === '"' || line === '\'') {
        return true;
      }

      // æ£€æŸ¥å‰ä¸€è¡Œæ˜¯å¦ä»¥ä¸å®Œæ•´çš„å¥å­ç»“å°¾
      if (prevResults.length > 0) {
        const lastResult = prevResults[prevResults.length - 1];
        if (typeof lastResult === 'string' && lastResult !== '<br>' && lastResult !== '\n') {
          // å‰ä¸€è¡Œæ²¡æœ‰å¥å·ç»“å°¾ï¼Œä¸”å½“å‰è¡Œå¾ˆçŸ­
          if (!lastResult.match(/[ã€‚ï¼ï¼Ÿ]$/) && line.length < 5) {
            return true;
          }
        }
      }

      return false;
    }

    // âŒ å·²åˆ é™¤ loadBlogs() - ä½¿ç”¨ app.js ä¸­çš„ window.loadBlogs()

    // ===== Phase 3: å‘½åç©ºé—´è¿ç§» =====
    
    // åˆ›å»º App å…¨å±€å‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (typeof window.App === 'undefined') {
      window.App = {};
    }
    
    // åˆ›å»º App.ui å­å‘½åç©ºé—´
    if (typeof window.App.ui === 'undefined') {
      window.App.ui = {};
    }
    
    // æ¸²æŸ“åšå®¢é¡¹ - å®˜ç½‘å¡ç‰‡æ ·å¼ï¼ˆçºµå‘ï¼Œå¸¦å›¾ç‰‡ï¼‰
    // âœ… ä¿ç•™æ­¤å‡½æ•° - ç”¨æˆ·é€‰æ‹©ä½¿ç”¨æ­¤æ ·å¼
    App.ui.renderBlogItem = function(blog) {
      const item = document.createElement('a');
      item.className = 'blog-card';
      item.href = `#blog/${blog.id}`;
      item.onclick = (e) => {
        e.preventDefault();
        // ä½¿ç”¨Routerè¿›è¡Œå¯¼èˆª
        if (window.Router) {
          Router.navigate(`#blog/${blog.id}`);
        }
      };
      
      // æå–ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆä»translated_contentæˆ–ä½¿ç”¨é»˜è®¤æ¸å˜ï¼‰
      let imageHtml = '';
      if (blog.translated_content) {
        const imageMatch = blog.translated_content.match(/!\[.*?\]\((https?:\/\/[^\)]+)\)/);
        if (imageMatch && imageMatch[1]) {
          // ä½¿ç”¨<img>æ ‡ç­¾ + æµè§ˆå™¨åŸç”Ÿæ‡’åŠ è½½ + ç»å¯¹å®šä½
          imageHtml = `<img src="${imageMatch[1]}" alt="${blog.title}" loading="lazy" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">`;
        }
      }
      
      // âœ… é˜¶æ®µ3ï¼šç›´æ¥ä½¿ç”¨é¢„å¤„ç†çš„ formatted_date
      const formattedDate = blog.formatted_date || blog.publish_date || 'æœªçŸ¥æ—¥æœŸ';
      
      item.innerHTML = `
        <div class="blog-card-image" style="position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          ${imageHtml}
        </div>
        <div class="blog-card-content">
          <div class="member-name mb-2" lang="ja">${blog.member || 'æœªçŸ¥æˆå‘˜'}</div>
          <div class="blog-meta mb-2">${formattedDate} ${blog.group_name || ''}</div>
          <h3 class="blog-title" lang="ja">${blog.title || 'æ— æ ‡é¢˜'}</h3>
        </div>
      `;
      
      return item; // è¿”å›å…ƒç´ ï¼Œç”±è°ƒç”¨è€…å†³å®šå¦‚ä½•æ·»åŠ åˆ°DOM
    }
    
    // è¿‡æ¸¡æœŸï¼šä¿ç•™ window æ˜ å°„ï¼ˆå‘åå…¼å®¹ï¼‰
    window.renderBlogItem = App.ui.renderBlogItem;
    
    console.log('[index.html] âœ… renderBlogItem å·²è¿ç§»åˆ° App.ui å‘½åç©ºé—´');
    
    // æ˜¾ç¤ºåšå®¢è¯¦æƒ…é¡µ
    window.showBlogDetail = function(blog, skipHistory = false, blogData = null) {
      console.log('[showBlogDetail] æ˜¾ç¤ºåšå®¢è¯¦æƒ…:', blog.id, 'å·²æœ‰æ•°æ®:', !!blogData);

      // å…ˆç§»é™¤å·²å­˜åœ¨çš„è¯¦æƒ…é¡µ(é˜²æ­¢é‡å¤)
      const existingDetail = document.getElementById('blogDetail');
      if (existingDetail) {
        console.log('[showBlogDetail] ç§»é™¤å·²å­˜åœ¨çš„è¯¦æƒ…é¡µ');
        existingDetail.remove();
      }

      // éšè—åˆ—è¡¨é¡µå’Œé¡µè„š
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');
      if (main) main.style.display = 'none';
      if (footer) footer.style.display = 'none';

      // ä¸å†ä½¿ç”¨ history.pushStateï¼Œç”± Router ç®¡ç†
      
      // åˆ›å»ºè¯¦æƒ…é¡µ - ä¸¤æ å¸ƒå±€
      const detailPage = document.createElement('main');
      detailPage.id = 'blogDetail';
      detailPage.className = 'container mx-auto px-4 py-8';
      detailPage.style.maxWidth = '1200px';
      
      detailPage.innerHTML = `
        <style>
          @media (max-width: 768px) {
            #blogDetail > div {
              grid-template-columns: 1fr !important;
            }
            .member-sidebar-detail {
              display: none !important;
            }
          }
        </style>
        <div style="display: grid; grid-template-columns: 1fr 320px; gap: 32px;">
          <!-- å·¦ä¾§ï¼šåšå®¢å†…å®¹ -->
          <article class="bg-white p-8 shadow-sm" style="border-radius: 8px;">
          <header class="mb-8 pb-6 border-b">
            <h1 class="text-3xl font-bold mb-4">${blog.title}</h1>
            <div class="flex items-center gap-4 text-gray-600">
              <span class="font-medium">${blog.member}</span>
              <span>Â·</span>
              <span>${blog.formatted_date || blog.publish_date || 'æœªçŸ¥æ—¥æœŸ'}</span>
              <span>Â·</span>
              <span class="text-sm">${window.GroupConfig?.getDisplayName(blog.group_name) || blog.group_name}</span>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
              <!-- âœ… åŒè¯­æ§ä»¶å›ºå®šæŒ‚è½½ç‚¹ -->
              <div id="bilingualControlMount"></div>
              
              <button class="action-btn primary" id="downloadAllBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span>ä¸‹è½½å…¨éƒ¨å›¾ç‰‡</span>
                <span id="imageCount"></span>
              </button>
              
              <div class="share-dropdown">
                <button class="action-btn" id="shareBtn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                  </svg>
                  <span>åˆ†äº«</span>
                </button>
                
                <div class="share-menu" id="shareMenu" style="display: none;">
                  <!-- ç¬¬ä¸€è¡Œ -->
                  <a class="share-option" data-action="qq" title="QQ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M21.395 15.035a39.548 39.548 0 0 0-.803-2.264l-1.079-2.695c.001-.032.014-.562.014-.836C19.526 4.632 17.081 0 12 0S4.474 4.632 4.474 9.241c0 .274.013.804.014.836l-1.08 2.695a39.548 39.548 0 0 0-.802 2.264c-1.021 3.283-.69 4.643-.438 4.673.54.063 2.063-2.48 2.063-2.48 0 1.193.381 2.286.822 3.465.443 1.179 1.021 2.03 1.794 2.4.603.288 1.963.564 5.153.564 3.19 0 4.55-.276 5.153-.564.773-.37 1.351-1.221 1.794-2.4.441-1.179.822-2.272.822-3.465 0 0 1.522 2.543 2.062 2.48.253-.03.584-1.39-.436-4.674z"/></svg>
                  </a>
                  <a class="share-option" data-action="weibo" title="å¾®åš">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9.56 14.5c-.47 1.46.43 2.88 1.88 3.07 1.42.18 3.09-.8 3.56-2.25.45-1.4-.43-2.78-1.87-2.97-1.45-.19-3.12.76-3.57 2.15zm11.64-5.78c-.32-.09-.54-.13-.37-.5.36-.81.4-1.51.01-2.01-.73-.94-2.74-.89-5.04.13 0 0-.72.33-.54-.27.36-1.18.3-2.17-.28-2.74-.86-.87-3.16.03-5.14 2-1.32 1.33-2.09 2.74-2.09 4.03 0 2.38 3.04 3.83 6.03 3.83 3.91 0 6.51-2.28 6.51-4.09 0-1.1-.93-1.72-2.09-2.38zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/></svg>
                  </a>
                  <a class="share-option" data-action="bilibili" title="å“”å“©å“”å“©">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/></svg>
                  </a>
                  <a class="share-option" data-action="twitter" title="Twitter/X">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                  </a>
                  <!-- ç¬¬äºŒè¡Œ -->
                  <a class="share-option" data-action="whatsapp" title="WhatsApp">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                  </a>
                  <a class="share-option" data-action="copy" title="å¤åˆ¶é“¾æ¥">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </a>
                  <a class="share-option" data-action="facebook" title="Facebook">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                  </a>
                  <a class="share-option" data-action="telegram" title="Telegram">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                  </a>
                </div>
              </div>
            </div>
          </header>
          
          <div id="blogContent" class="blog-content-official">
            <p class="text-gray-500">æ­£åœ¨åŠ è½½ç¿»è¯‘å†…å®¹...</p>
          </div>
          
          <footer class="mt-8 pt-6 border-t">
            <a href="${blog.original_url || '#'}" target="_blank" class="more-btn">
              æŸ¥çœ‹åŸæ–‡
            </a>
          </footer>
        </article>
        
        <!-- å³ä¾§ï¼šæˆå‘˜ä¿¡æ¯å’Œæ—¥å† -->
        <aside class="member-sidebar-detail" style="position: sticky; top: 80px; height: fit-content; overflow: visible;">
          <!-- æˆå‘˜ä¿¡æ¯å¡ç‰‡ -->
          <div class="sidebar-card" style="padding: 24px; margin-bottom: 20px; text-align: center;">
            <div style="width: 240px; height: 300px; overflow: hidden; background: #f5f5f5; margin: 0 auto 16px; clip-path: polygon(0 0, 100% 0, 100% 80%, 75% 100%, 0 100%);">
              <div id="detailMemberAvatar" style="width:100%;height:100%;background:#f5f5f5;display:flex;align-items:center;justify-content:center;font-size:48px;color:#999;">
                <span>${blog.member.charAt(0)}</span>
              </div>
            </div>
            <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #333;">${blog.member}</h3>
            <p style="font-size: 12px; color: #999; margin-bottom: 0;">${window.GroupConfig?.getDisplayName(blog.group_name) || blog.group_name}</p>
          </div>
          
          <!-- æ—¥å† -->
          <div class="sidebar-card calendar-section" style="padding: 24px; overflow: visible;">
            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 16px;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
            <div id="detailCalendarDates" style="overflow: visible;">
              <!-- æ—¥å†å†…å®¹ï¼ˆåŒ…æ‹¬æ˜ŸæœŸæ ‡é¢˜ï¼‰å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
          </div>
          
          <!-- NEW ENTRY -->
          <div class="sidebar-card" style="padding: 20px; margin-top: 20px;">
            <h3 style="font-size: 14px; font-weight: bold; margin-bottom: 16px;">NEW ENTRY</h3>
            <ul id="detailNewEntries" style="list-style: none; padding: 0; margin: 0;">
              <!-- æœ€æ–°åšå®¢å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </ul>
            <!-- View More æŒ‰é’® -->
            <div style="margin-top: 16px;">
              <a id="viewMoreLink" href="#" style="display: inline-block; color: #fff; background: #9dccb5; font-size: 14px; width: 100%; height: 45px; line-height: 45px; text-align: center; border-radius: 5px; text-decoration: none; transition: opacity 0.3s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">ã‚‚ã£ã¨è¦‹ã‚‹</a>
            </div>
          </div>
        </aside>
        </div>
      `;
      
      document.body.appendChild(detailPage);
      
      // ğŸ–¼ï¸ åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½ï¼ˆ2è¡Œï¼‰
      document.querySelectorAll('img[data-src]').forEach(img => 
        lazyLoadObserver.observe(img)
      );
      
      // æ·»åŠ è¿›å…¥åŠ¨ç”»
      if (typeof animateBlogDetail === 'function') {
        animateBlogDetail('enter');
      }
      
      // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆåœ¨DOMæ·»åŠ åï¼‰- ä½¿ç”¨å¤šæ¬¡å°è¯•ç¡®ä¿æˆåŠŸ
      let attemptCount = 0;
      const maxAttempts = 5;
      
      const bindEvents = () => {
        attemptCount++;
        console.log(`ğŸ”„ Attempt ${attemptCount} to bind events...`);
        
        const downloadBtn = document.getElementById('downloadAllBtn');
        const shareBtn = document.getElementById('shareBtn');
        
        console.log('ğŸ“ Button elements:', {
          downloadBtn: downloadBtn ? 'found' : 'NOT FOUND',
          shareBtn: shareBtn ? 'found' : 'NOT FOUND',
          downloadBtnId: downloadBtn?.id,
          shareBtnId: shareBtn?.id
        });
        
        if (downloadBtn && shareBtn) {
          console.log('âœ… Both buttons found! Binding events...');
          
          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
          const newDownloadBtn = downloadBtn.cloneNode(true);
          downloadBtn.parentNode.replaceChild(newDownloadBtn, downloadBtn);
          
          const newShareBtn = shareBtn.cloneNode(true);
          shareBtn.parentNode.replaceChild(newShareBtn, shareBtn);
          
          // ç»‘å®šä¸‹è½½æŒ‰é’®
          newDownloadBtn.onclick = function(e) {
            console.log('ğŸ”½ Download button clicked!');
            e.preventDefault();
            e.stopPropagation();
            try {
              downloadAllImages();
            } catch (err) {
              console.error('Download error:', err);
              alert('ä¸‹è½½å¤±è´¥: ' + err.message);
            }
          };
          console.log('âœ… Download button bound');
          
          // ç»‘å®šåˆ†äº«æŒ‰é’®
          newShareBtn.onclick = function(e) {
            console.log('ğŸ”— Share button clicked!');
            e.preventDefault();
            e.stopPropagation();
            try {
              toggleShareMenu(e);
            } catch (err) {
              console.error('Share error:', err);
              alert('åˆ†äº«èœå•æ‰“å¼€å¤±è´¥: ' + err.message);
            }
          };
          console.log('âœ… Share button bound');
          
          // æµ‹è¯•æŒ‰é’®æ˜¯å¦å¯ç‚¹å‡»
          console.log('ğŸ§ª Testing button click simulation...');
          
          // ç»‘å®šåˆ†äº«é€‰é¡¹äº‹ä»¶
          setTimeout(() => {
            const shareOptions = document.querySelectorAll('.share-option');
            console.log('ğŸ“± Found', shareOptions.length, 'share options');
            shareOptions.forEach(option => {
              const action = option.getAttribute('data-action');
              if (action) {
                option.onclick = function(e) {
                  console.log('Share action:', action);
                  e.preventDefault();
                  e.stopPropagation();
                  
                  try {
                    switch(action) {
                      case 'qq': shareToQQ(); break;
                      case 'weibo': shareToWeibo(); break;
                      case 'bilibili': shareToBilibili(); break;
                      case 'twitter': shareToTwitter(); break;
                      case 'whatsapp': shareToWhatsApp(); break;
                      case 'copy': copyLink(); break;
                      case 'facebook': shareToFacebook(); break;
                      case 'telegram': shareToTelegram(); break;
                    }
                  } catch (err) {
                    console.error('Share action error:', err);
                    alert('åˆ†äº«å¤±è´¥: ' + err.message);
                  }
                };
              }
            });
          }, 100);
          
        } else {
          console.warn(`âš ï¸ Buttons not ready yet (attempt ${attemptCount}/${maxAttempts})`);
          if (attemptCount < maxAttempts) {
            setTimeout(bindEvents, 500);
          } else {
            console.error('âŒ Failed to find buttons after', maxAttempts, 'attempts');
            console.error('Available elements:', {
              allButtons: document.querySelectorAll('button').length,
              buttonIds: Array.from(document.querySelectorAll('button')).map(b => b.id)
            });
          }
        }
      };
      
      setTimeout(bindEvents, 100);
      
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo(0, 0);

      // åŠ è½½å®Œæ•´çš„ç¿»è¯‘å†…å®¹
      if (blogData) {
        console.log('[showBlogDetail] ä½¿ç”¨å·²æœ‰æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚');
        loadBlogContentWithData(blogData);
      } else {
        console.log('[showBlogDetail] ä» API è·å–æ•°æ®');
        loadBlogContent(blog.id);
      }
    }
    
    // å…³é—­è¯¦æƒ…é¡µ
    function closeBlogDetail() {
      const detailPage = document.getElementById('blogDetail');
      if (detailPage) {
        // æ·»åŠ é€€å‡ºåŠ¨ç”»
        if (typeof animateBlogDetail === 'function') {
          animateBlogDetail('exit');
        } else {
          detailPage.remove();
        }
      }
      
      // å»¶è¿Ÿæ˜¾ç¤ºä¸»å†…å®¹ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
      setTimeout(() => {
        document.querySelector('main').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        window.scrollTo(0, 0);
      }, 100);
    }
    
    // åŠ è½½åšå®¢å®Œæ•´å†…å®¹(ä½¿ç”¨å·²æœ‰æ•°æ®)
    async function loadBlogContentWithData(blog) {
      console.log('[loadBlogContentWithData] ä½¿ç”¨å·²æœ‰åšå®¢æ•°æ®:', blog.id);

      // å­˜å‚¨å½“å‰åšå®¢æ•°æ®ä¾›ä¸‹è½½å’Œåˆ†äº«ä½¿ç”¨
      App.view.currentBlog = blog;

      // æ›´æ–°åŸæ–‡é“¾æ¥
      const originalLink = document.querySelector('.more-btn');
      if (originalLink) {
        if (blog.original_url) {
          originalLink.href = blog.original_url;
          console.log('è®¾ç½®åŸæ–‡é“¾æ¥:', blog.original_url);
        } else {
          // å¦‚æœæ²¡æœ‰original_urlï¼Œæ ¹æ®IDå’Œå›¢ä½“æ„å»ºURL
          const blogId = blog.id;
          let baseUrl = '';

          if (blogId.includes('nogizaka')) {
            baseUrl = 'https://www.nogizaka46.com/s/n46/diary/detail/';
          } else if (blogId.includes('sakurazaka')) {
            baseUrl = 'https://sakurazaka46.com/s/s46/diary/detail/';
          } else if (blogId.includes('hinatazaka')) {
            baseUrl = 'https://www.hinatazaka46.com/s/official/diary/detail/';
          }

          if (baseUrl) {
            // æå–å®é™…çš„åšå®¢IDï¼ˆæ•°å­—éƒ¨åˆ†ï¼‰
            const actualId = blogId.split('-').pop();
            originalLink.href = baseUrl + actualId;
            console.log('æ„å»ºåŸæ–‡é“¾æ¥:', originalLink.href);
          }
        }
      }

      // æ¸²æŸ“å†…å®¹
      const contentDiv = document.getElementById('blogContent');
      if (contentDiv) {
        let rendered;
        
        // ä¼˜å…ˆä½¿ç”¨åŒè¯­å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (blog.bilingual_content) {
          console.log('âœ… æ£€æµ‹åˆ°åŒè¯­å†…å®¹ï¼Œç›´æ¥ä½¿ç”¨');
          // åŒè¯­å†…å®¹å·²ç»æ˜¯å®Œæ•´çš„HTMLï¼Œç›´æ¥ä½¿ç”¨
          rendered = blog.bilingual_content;
        } else if (blog.translated_content) {
          console.log('ä½¿ç”¨ç¿»è¯‘å†…å®¹ï¼ˆæ— åŒè¯­ï¼‰');
          // æ¸²æŸ“ Markdown å†…å®¹ï¼ˆä¼ é€’å›¢ä½“åç§°ï¼‰
          const groupName = window.GroupConfig?.getDisplayName(blog.group_name) || blog.group_name;
          rendered = renderMarkdown(blog.translated_content, groupName);
        } else {
          rendered = '<p class="text-gray-500">æš‚æ— å†…å®¹</p>';
        }

        // è®¾ç½®å†…å®¹ï¼ˆä½¿ç”¨innerHTMLä»¥æ”¯æŒHTMLæ ‡ç­¾ï¼‰
        contentDiv.innerHTML = rendered;

        // æ›´æ–°å›¾ç‰‡æ•°é‡
        const images = window.extractImagesFromContent ? extractImagesFromContent() : [];
        const imageCountEl = document.getElementById('imageCount');
        if (imageCountEl) {
          if (images.length > 0) {
            imageCountEl.textContent = `(${images.length}å¼ )`;
          } else {
            // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç¦ç”¨ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadAllBtn');
            if (downloadBtn) {
              downloadBtn.disabled = true;
              downloadBtn.style.opacity = '0.5';
              downloadBtn.style.cursor = 'not-allowed';
            }
          }
        }
      }

      // åªè°ƒç”¨ä¸€æ¬¡ BlogDetailSidebar.init
      if (window.BlogDetailSidebar) {
        console.log('[loadBlogContentWithData] åˆå§‹åŒ–ä¾§è¾¹æ ');
        await window.BlogDetailSidebar.init(blog);
      }
      
      // åˆå§‹åŒ–åŒè¯­æ§ä»¶ï¼ˆå†…å®¹åŠ è½½å®Œæˆåï¼Œä½¿ç”¨æ›´å¯é çš„æ–¹å¼ï¼‰
      if (typeof BilingualControl !== 'undefined' || window.BilingualControl) {
        console.log('[loadBlogContentWithData] åˆå§‹åŒ–åŒè¯­æ§ä»¶');
        // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
        requestAnimationFrame(() => {
          // å¦‚æœå·²å­˜åœ¨å®ä¾‹ï¼Œå…ˆé”€æ¯
          if (window.bilingualControl && typeof window.bilingualControl.destroy === 'function') {
            window.bilingualControl.destroy();
          }
          // åˆ›å»ºæ–°å®ä¾‹
          window.bilingualControl = new BilingualControl();
          // åŒæ­¥åˆ°Appå‘½åç©ºé—´
          if (window.App && window.App.bilingual) {
            window.App.bilingual.control = window.bilingualControl;
          }
        });
      }
    }

    // åŠ è½½åšå®¢å®Œæ•´å†…å®¹(ä»APIè·å–)
    async function loadBlogContent(blogId) {
      try {
        const apiBase = window.API_BASE_URL || window.API_BASE;
        const response = await fetch(`${apiBase}/api/blogs/${blogId}`);
        const data = await response.json();
        
        if (data.success && data.blog) {
          // âœ¨ æ•°æ®æºå¤„ç†ï¼šç»Ÿä¸€æ ¼å¼åŒ–æ—¥æœŸ
          const processedBlog = window.processBlogData 
            ? window.processBlogData(data.blog) 
            : data.blog;
          // å­˜å‚¨å½“å‰åšå®¢æ•°æ®ä¾›ä¸‹è½½å’Œåˆ†äº«ä½¿ç”¨
          App.view.currentBlog = processedBlog;
          console.log('Loaded blog data:', processedBlog);
          
          // æ›´æ–°åŸæ–‡é“¾æ¥ - ä¿®å¤URLæ ¼å¼
          const originalLink = document.querySelector('.more-btn');
          if (originalLink) {
            if (processedBlog.original_url) {
              originalLink.href = processedBlog.original_url;
              console.log('è®¾ç½®åŸæ–‡é“¾æ¥:', processedBlog.original_url);
            } else {
              // å¦‚æœæ²¡æœ‰original_urlï¼Œæ ¹æ®IDå’Œå›¢ä½“æ„å»ºURL
              const blogId = processedBlog.id;
              let baseUrl = '';
              
              if (blogId.includes('nogizaka')) {
                baseUrl = 'https://www.nogizaka46.com/s/n46/diary/detail/';
              } else if (blogId.includes('sakurazaka')) {
                baseUrl = 'https://sakurazaka46.com/s/s46/diary/detail/';
              } else if (blogId.includes('hinatazaka')) {
                baseUrl = 'https://www.hinatazaka46.com/s/official/diary/detail/';
              }
              
              if (baseUrl) {
                // æå–å®é™…çš„åšå®¢IDï¼ˆæ•°å­—éƒ¨åˆ†ï¼‰
                const actualId = blogId.split('-').pop();
                originalLink.href = baseUrl + actualId;
                console.log('æ„å»ºåŸæ–‡é“¾æ¥:', originalLink.href);
              }
            }
          }
          
          const contentDiv = document.getElementById('blogContent');
          if (contentDiv) {
            let rendered;
            
            // ä¼˜å…ˆä½¿ç”¨åŒè¯­å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (data.blog.bilingual_content) {
              console.log('âœ… æ£€æµ‹åˆ°åŒè¯­å†…å®¹ï¼Œç›´æ¥ä½¿ç”¨');
              // åŒè¯­å†…å®¹å·²ç»æ˜¯å®Œæ•´çš„HTMLï¼Œç›´æ¥ä½¿ç”¨
              rendered = data.blog.bilingual_content;
            } else if (data.blog.translated_content) {
              console.log('ä½¿ç”¨ç¿»è¯‘å†…å®¹ï¼ˆæ— åŒè¯­ï¼‰');
              // æ¸²æŸ“ Markdown å†…å®¹ï¼ˆä¼ é€’å›¢ä½“åç§°ï¼‰
              const groupName = window.GroupConfig?.getDisplayName(data.blog.group_name) || data.blog.group_name;
              rendered = renderMarkdown(data.blog.translated_content, groupName);
            } else {
              rendered = '<p class="text-gray-500">æš‚æ— å†…å®¹</p>';
            }
            
            // è®¾ç½®å†…å®¹ï¼ˆä½¿ç”¨innerHTMLä»¥æ”¯æŒHTMLæ ‡ç­¾ï¼‰
            contentDiv.innerHTML = rendered;
            
            // æ›´æ–°å›¾ç‰‡æ•°é‡
            const images = window.extractImagesFromContent ? extractImagesFromContent() : [];
            const imageCountEl = document.getElementById('imageCount');
            if (imageCountEl) {
              if (images.length > 0) {
                imageCountEl.textContent = `(${images.length}å¼ )`;
              } else {
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç¦ç”¨ä¸‹è½½æŒ‰é’®
                const downloadBtn = document.getElementById('downloadAllBtn');
                if (downloadBtn) {
                  downloadBtn.disabled = true;
                  downloadBtn.style.opacity = '0.5';
                  downloadBtn.style.cursor = 'not-allowed';
                }
              }
            }
          }
          
          // ä½¿ç”¨æ–°æ¨¡å—åŠ è½½ä¾§è¾¹æ æ•°æ®
          if (window.BlogDetailSidebar) {
            await window.BlogDetailSidebar.init(data.blog);
          }
          
          // åˆå§‹åŒ–åŒè¯­æ§ä»¶ï¼ˆå†…å®¹åŠ è½½å®Œæˆåï¼Œä½¿ç”¨æ›´å¯é çš„æ–¹å¼ï¼‰
          if (typeof BilingualControl !== 'undefined' || window.BilingualControl) {
            console.log('[loadBlogContent] åˆå§‹åŒ–åŒè¯­æ§ä»¶');
            // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
            requestAnimationFrame(() => {
              // å¦‚æœå·²å­˜åœ¨å®ä¾‹ï¼Œå…ˆé”€æ¯
              if (window.bilingualControl && typeof window.bilingualControl.destroy === 'function') {
                window.bilingualControl.destroy();
              }
              // åˆ›å»ºæ–°å®ä¾‹
              window.bilingualControl = new BilingualControl();
              // åŒæ­¥åˆ°Appå‘½åç©ºé—´
              if (window.App && window.App.bilingual) {
                window.App.bilingual.control = window.bilingualControl;
              }
            });
          }
        }
      } catch (error) {
        console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
        const contentDiv = document.getElementById('blogContent');
        if (contentDiv) {
          contentDiv.innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
          console.error('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error.message);
          const apiBase = window.API_BASE_URL || window.API_BASE;
          console.error('API URL:', `${apiBase}/api/blogs/${blogId}`);
        }
      }
    }

    // ä¾§è¾¹æ åŠŸèƒ½å·²ç§»è‡³ blog-detail-sidebar.js æ¨¡å—
    
    // âœ… å·²è¿ç§»çŠ¶æ€å˜é‡ - ç»Ÿä¸€ä½¿ç”¨ App.state.hasMore, App.state.totalPages ç­‰
    // âŒ å·²åˆ é™¤ loadMoreBlogs() - ä½¿ç”¨ app.js ä¸­çš„ window.loadBlogs(append=true)
    // âŒ å·²åˆ é™¤ setupInfiniteScroll() - ä½¿ç”¨ app.js ä¸­çš„ window.setupInfiniteScroll()

    // âœ… å·²è¿ç§»æœç´¢å˜é‡ - ç»Ÿä¸€ä½¿ç”¨ App.state.search
    // âŒ å·²åˆ é™¤æœ¬åœ°æœç´¢ (filterBlogs) - ä½¿ç”¨ app.js ä¸­çš„æœåŠ¡ç«¯æœç´¢ (performSearch + enhanceSearchInput)

    // ========== ä¸‹è½½å’Œåˆ†äº«åŠŸèƒ½ ==========
    
    // âœ… ä½¿ç”¨ç»Ÿä¸€çŠ¶æ€ç®¡ç† - App.view.currentBlog (å·²åœ¨ state.js ä¸­å®šä¹‰)
    
    // æµ‹è¯•å‡½æ•°æ˜¯å¦å¯ç”¨
    console.log('ğŸ§ª Functions loaded:', {
      downloadAllImages: typeof downloadAllImages,
      toggleShareMenu: typeof toggleShareMenu,
      showToast: typeof showToast
    });
    
    // å›¾ç‰‡ä¸‹è½½å‡½æ•°å·²ç§»è‡³æ¨¡å—æ–‡ä»¶
    // js/image-download.js - å›¾ç‰‡ä¸‹è½½åŠŸèƒ½
    
    // extractImages å’Œ downloadAllImages å·²ç§»è‡³ js/image-download.js
    
    // åˆ†äº«èœå•æ§åˆ¶
    function toggleShareMenu(event) {
      console.log('ğŸ”— toggleShareMenu called');
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      
      const menu = document.getElementById('shareMenu');
      console.log('ğŸ“± Share menu element:', menu);
      
      if (menu) {
        const isShowing = menu.classList.contains('show');
        console.log('Current state:', isShowing ? 'showing' : 'hidden');
        menu.classList.toggle('show');
        console.log('New state:', menu.classList.contains('show') ? 'showing' : 'hidden');
      } else {
        console.error('âŒ Share menu element not found!');
      }
    }
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­åˆ†äº«èœå•
    document.addEventListener('click', () => {
      const menu = document.getElementById('shareMenu');
      if (menu) menu.classList.remove('show');
    });
    
    // åˆ†äº«å’Œå·¥å…·å‡½æ•°å·²ç§»è‡³æ¨¡å—æ–‡ä»¶
    // js/share-module.js - åˆ†äº«åŠŸèƒ½
    // js/utils.js - å·¥å…·å‡½æ•°
    
    // è¿›åº¦å¯¹è¯æ¡†
    function showProgressDialog(message, progress) {
      let dialog = document.getElementById('downloadProgress');
      if (!dialog) {
        dialog = document.createElement('div');
        dialog.id = 'downloadProgress';
        dialog.className = 'download-progress';
        dialog.innerHTML = `
          <div id="progressMessage" style="font-size: 14px; color: #374151; margin-bottom: 8px;"></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div id="progressPercent" style="font-size: 12px; color: #6b7280;"></div>
        `;
        document.body.appendChild(dialog);
      }
      
      updateProgressDialog(message, progress);
    }
    
    function updateProgressDialog(message, progress) {
      const dialog = document.getElementById('downloadProgress');
      if (!dialog) return;
      
      document.getElementById('progressMessage').textContent = message;
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
    }
    
    function hideProgressDialog() {
      const dialog = document.getElementById('downloadProgress');
      if (dialog) {
        dialog.remove();
      }
    }
    
    // ========== åŸæœ‰åŠŸèƒ½ ==========
    
    // popstate å¤„ç†å·²ç§»è‡³ Router æ¨¡å—

    // âŒ åˆ é™¤é‡å¤çš„åˆ†é¡µå‡½æ•° - ç»Ÿä¸€ä½¿ç”¨ Pagination æ¨¡å—
    // ä¹‹å‰çš„ createPageButton, jumpToPage ç­‰å‡½æ•°å·²åˆ é™¤
    // åˆ†é¡µåŠŸèƒ½ç”± js/pagination.js çš„ Pagination æ¨¡å—ç»Ÿä¸€ç®¡ç†

    // âŒ å·²åˆ é™¤ DOMContentLoaded åˆå§‹åŒ– - ç»Ÿä¸€ç§»è‡³ app.js ä¸­æ‰§è¡Œ
    // åˆå§‹åŒ–é¡ºåºï¼šapp.js å…ˆåˆå§‹åŒ–æ ¸å¿ƒç³»ç»Ÿï¼Œå†åˆå§‹åŒ– UI æ¨¡å—ï¼ˆPagination, MemberPage, Routerï¼‰
  </script>
  
  <!-- JSæ¨¡å—æ–‡ä»¶ï¼ˆæŒ‰åŠ è½½é¡ºåºï¼‰ -->
  <script src="js/state.js"></script>  <!-- âœ… ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼ˆæœ€å…ˆåŠ è½½ï¼‰ -->
  <script src="js/utils.js"></script>
  <script src="js/utils/markdown-processor.js"></script>  <!-- Markdown ç»Ÿä¸€å¤„ç†å™¨ -->
  <script src="js/blog-renderer.js"></script>  <!-- åšå®¢æ¸²æŸ“å™¨ï¼ˆæ–°ç‰ˆï¼‰-->
  <script src="js/app.js"></script>  <!-- ä¸»åº”ç”¨é€»è¾‘ -->
  <script src="js/share-module.js"></script>
  <script src="js/image-download.js"></script>
  <script src="js/page-transitions.js"></script>
  <script src="js/mobile-menu.js"></script>
  <script src="js/mobile-download.js"></script>
  <script src="js/sidebar-sticky.js"></script>  <!-- ä¾§è¾¹æ æ™ºèƒ½å›ºå®š -->
  <script src="js/bilingual-control-v2.js"></script>  <!-- åŒè¯­åšå®¢æ˜¾ç¤ºæ¨¡å¼æ§åˆ¶V2 -->
</body>
</html>
